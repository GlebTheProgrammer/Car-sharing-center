@model CarSharingApp.Application.Contracts.Vehicle.CreateVehicleRequest;

<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyC9AIXs7jB_3r8oRc1zd0i9p0nanEH5Q6M&callback=initMap" async defer></script>

<main class="container mt-5">
    <div class="row g-5">
        <form id="createNewVehicleForm" class="row g-3 needs-validation" asp-controller="AddVehicle" asp-action="AddVehicle" method="post" novalidate>
            <div class="col-md-7 g-2 row justify-content-center">
                <h3 class="pb-2 mb-4 fst-italic border-bottom text-center">
                    Share Your Vehicle
                </h3>

                <div class="rounded" id="noCarImage">
                    <div class="w-full p-3">
                        <div class="d-flex justify-content-center align-items-center">
                            <div class="flex flex-col items-center">
                                <i class="fa fa-folder-open fa-4x"></i>
                                <span>Upload Vehicle Image <label class="text-danger">*</label></span>
                            </div>
                        </div>
                    </div>
                </div>

                <img class="img-fluid mt-3 mx-auto d-block rounded" id="carImage" style="height: auto" src="">

                <div class="row justify-content-center mt-3">
                    <div class="col-md-12 col-lg-10 col-12">
                        <div class="input-group"> 
                            <input id="ImageFileInputErrorValidationCustom" type="file" name="file" onchange="onFileSelected(event)" accept="image/png, image/jpeg" class="form-control" required onclick="SetInputAsRequireValidation(this)" />
                            <button class="btn btn-outline-secondary" type="button" id="unloadImageButton" onclick="UnloadImage();" disabled>Unload</button>
                            <div class="valid-feedback">
                                Uploaded successfully!
                            </div>
                            <div id="ImageFileInputErrorValidation" class="invalid-feedback">
                                Please upload vehicle Image.
                            </div>
                        </div>
                    </div>
                </div>

                <!--Image input starts here-->
                <input id="imageInput" asp-for="Image" class="form-control" value="" hidden />
                <!--Image input ends here-->

                <h2 class="mt-4 mb-3">Specifications</h2>

                <div class="col-6">
                    <label for="productionYearErrorValidationCustom" class="form-label">Production year <label class="text-danger">*</label></label>
                    <input asp-for="ProductionYear" type="text" class="form-control" id="productionYearErrorValidationCustom" required maxlength="4" pattern="\d{4}" onclick="SetInputAsRequireValidation(this)">
                    <div class="valid-feedback">
                        Looks good!
                    </div>
                    <div id="firstNameErrorValidation" class="invalid-feedback">
                        Please provide a valid Production year.
                    </div>
                </div>

                <div class="col-6">
                    <label for="maxSpeedKphErrorValidationCustom" class="form-label">Max speed (KM/H) <label class="text-danger">*</label></label>
                    <input asp-for="MaxSpeedKph" type="text" class="form-control" id="maxSpeedKphErrorValidationCustom" required maxlength="4" pattern="\d{4}" onclick="SetInputAsRequireValidation(this)">
                    <div class="valid-feedback">
                        Looks good!
                    </div>
                    <div id="maxSpeedKphErrorValidation" class="invalid-feedback">
                        Please provide a valid Max vehicle speed.
                    </div>
                </div>

                <div class="col-4">
                    <label for="exteriorColorErrorValidationCustom" class="form-label">Exterior color <label class="text-danger">*</label></label>
                    <select asp-for="ExteriorColor" class="form-select" id="exteriorColorErrorValidationCustom" required onclick="SetInputAsRequireValidation(this)">
                        <option selected disabled value="">Choose...</option>
                        @foreach (var color in CarSharingApp.Domain.SmartEnums.Colour.GetPossibleEnumerations())
                        {
                            <option value="@CarSharingApp.Domain.SmartEnums.Colour.FromName(color)">@color</option>
                        }
                    </select>
                    <div class="valid-feedback">
                        Looks good!
                    </div>
                    <div id="exteriorColorErrorValidation" class="invalid-feedback">
                        Please select vehicle Exterior color.
                    </div>
                </div>

                <div class="col-4">
                    <label for="interiorColorErrorValidationCustom" class="form-label">Interior color <label class="text-danger">*</label></label>
                    <select asp-for="InteriorColor" class="form-select" id="interiorColorErrorValidationCustom" required onclick="SetInputAsRequireValidation(this)">
                        <option selected disabled value="">Choose...</option>
                        @foreach (var color in CarSharingApp.Domain.SmartEnums.Colour.GetPossibleEnumerations())
                        {
                            <option value="@CarSharingApp.Domain.SmartEnums.Colour.FromName(color)">@color</option>
                        }
                    </select>
                    <div class="valid-feedback">
                        Looks good!
                    </div>
                    <div id="exteriorColorErrorValidation" class="invalid-feedback">
                        Please select vehicle Interior color.
                    </div>
                </div>

                <div class="col-4">
                    <label for="drivetrainErrorValidationCustom" class="form-label">Drivetrain <label class="text-danger">*</label></label>
                    <select asp-for="Drivetrain" class="form-select" id="drivetrainErrorValidationCustom" required onclick="SetInputAsRequireValidation(this)">
                        <option selected disabled value="">Choose...</option>
                        @foreach (var drivetrain in CarSharingApp.Domain.SmartEnums.Drivetrain.GetPossibleEnumerations())
                        {
                            <option value="@CarSharingApp.Domain.SmartEnums.Drivetrain.FromName(drivetrain)">@drivetrain</option>
                        }
                    </select>
                    <div class="valid-feedback">
                        Looks good!
                    </div>
                    <div id="drivetrainErrorValidation" class="invalid-feedback">
                        Please select vehicle Drivetrain.
                    </div>
                </div>

                <div class="col-4">
                    <label for="fuelTypeErrorValidationCustom" class="form-label">Fuel type <label class="text-danger">*</label></label>
                    <select asp-for="FuelType" class="form-select" id="fuelTypeErrorValidationCustom" required onclick="SetInputAsRequireValidation(this)">
                        <option selected disabled value="">Choose...</option>
                        @foreach (var fuelType in CarSharingApp.Domain.SmartEnums.FuelType.GetPossibleEnumerations())
                        {
                            <option value="@CarSharingApp.Domain.SmartEnums.FuelType.FromName(fuelType)">@fuelType</option>
                        }
                    </select>
                    <div class="valid-feedback">
                        Looks good!
                    </div>
                    <div id="fuelTypeErrorValidation" class="invalid-feedback">
                        Please select vehicle Fuel type.
                    </div>
                </div>

                <div class="col-4">
                    <label for="transmissionErrorValidationCustom" class="form-label">Transmission <label class="text-danger">*</label></label>
                    <select asp-for="Transmission" class="form-select" id="transmissionErrorValidationCustom" required onclick="SetInputAsRequireValidation(this)">
                        <option selected disabled value="">Choose...</option>
                        @foreach (var transmission in CarSharingApp.Domain.SmartEnums.Transmission.GetPossibleEnumerations())
                        {
                            <option value="@CarSharingApp.Domain.SmartEnums.Transmission.FromName(transmission)">@transmission</option>
                        }
                    </select>
                    <div class="valid-feedback">
                        Looks good!
                    </div>
                    <div id="transmissionErrorValidation" class="invalid-feedback">
                        Please select vehicle Transmission.
                    </div>
                </div>

                <div class="col-4">
                    <label for="engineErrorValidationCustom" class="form-label">Engine <label class="text-danger">*</label></label>
                    <select asp-for="Engine" class="form-select" id="engineErrorValidationCustom" required onclick="SetInputAsRequireValidation(this)">
                        <option selected disabled value="">Choose...</option>
                        @foreach (var engine in CarSharingApp.Domain.SmartEnums.Engine.GetPossibleEnumerations())
                        {
                            <option value="@CarSharingApp.Domain.SmartEnums.Engine.FromName(engine)">@engine</option>
                        }
                    </select>
                    <div class="valid-feedback">
                        Looks good!
                    </div>
                    <div id="engineErrorValidation" class="invalid-feedback">
                        Please select vehicle Engine.
                    </div>
                </div>

                <div class="col-6">
                    <label for="vinErrorValidationCustom" class="form-label">VIN <label class="text-danger">*</label></label>
                    <input asp-for="VIN" type="text" class="form-control" id="vinErrorValidationCustom" required pattern="^[A-HJ-NPR-Za-hj-npr-z\\d]{8}[\\dX][A-HJ-NPR-Za-hj-npr-z\\d]{2}\\d{6}$" onclick="SetInputAsRequireValidation(this)">
                    <div class="valid-feedback">
                        Looks good!
                    </div>
                    <div id="vinErrorValidation" class="invalid-feedback">
                        Please provide a valid VIN.
                    </div>
                </div>
                
                <hr class="featurette-divider mt-4">

                <h2 class="mt-2">Categories</h2>

                <label class="mt-2 mr-2 mb-3">Note: Here you can select any keywords that may be associated with your vehicle. If you can't add any of them, please, skip this section and move to the next one.</label>

                <div class="mt-2 text-center">
                    @foreach (var category in CarSharingApp.Domain.Enums.FlagEnums.GetPossibleValues<CarSharingApp.Domain.Enums.FlagEnums.Categories>())
                    {
                        if (category.Equals("None"))
                            continue;

                        <div class="form-check form-check-inline mb-3" style="margin-right: 5px; padding-left: 0px;">
                            <input type="checkbox" class="btn-check" id="btn-check-outlined-@category" autocomplete="off" value="@category" onchange="FilterCategories(this,'@category')">
                            <label class="btn btn-outline-info" for="btn-check-outlined-@category">@category</label><br>
                        </div>
                    }
                    <div class="d-flex flex-row visually-hidden">
                        <input asp-for="Categories" type="text" class="form-control text-center" style="width: 15%" id="categoriesInput" readonly>
                    </div>
                </div>

                <hr class="featurette-divider">

                <h2 class="mt-3">Address Info</h2>

                <label class="mt-2 mr-2">Note: Please fill all the current location fields of the vehicle down below, then click the «Search» button. If the address was found, a marker will appear on the map. If error occured, you will see error message and marker will not be set. If so, please try again.</label>

                <div>
                    <span asp-validation-for="StreetAddress" id="StreetAddressError" class="text-danger text-center" style="margin-left: 175px;"></span>
                    <div class="d-flex flex-row">
                        <input asp-for="StreetAddress" type="text" id="vehicleStreetAddress" class="form-control mr-2" placeholder="Street address" onfocus="HideErrorSpan('StreetAddressError')">
                    </div>
                </div>
                <div>
                    <span asp-validation-for="AptSuiteEtc" id="AptSuiteEtcError" class="text-danger text-center" style="margin-left: 175px;"></span>
                    <div class="d-flex flex-row">
                        <input asp-for="AptSuiteEtc" type="text" id="vehicleAptSuiteEtc" class="form-control mr-2" placeholder="Apartment, suite, etc" onfocus="HideErrorSpan('AptSuiteEtcError')">
                    </div>
                </div>
                <div>
                    <span asp-validation-for="Country" id="CountryError" class="text-danger text-center" style="margin-left: 175px;"></span>
                    <div class="d-flex flex-row">
                        <input asp-for="Country" type="text" id="vehicleCountry" class="form-control mr-2" placeholder="Country" onfocus="HideErrorSpan('CountryError')">
                    </div>
                </div>
                <div>
                    <span asp-validation-for="City" id="CityError" class="text-danger text-center" style="margin-left: 175px;"></span>
                    <div class="d-flex flex-row">
                        <input asp-for="City" type="text" id="vehicleCity" class="form-control mr-2" placeholder="City" onfocus="HideErrorSpan('CityError')">
                    </div>
                </div>

                <span asp-validation-for=Latitude id="AddressLatitideLongitudeError" class="d-flex justify-content-center text-danger text-center mt-2 mb-2"></span>

                <div class="mt-4">
                    <div class="container-fluid">
                        <div id="map" class="text-center" style="height: 400px; width: 100%;"></div>
                        <script>
                            var map;
                            function initMap() {

                                if ("@Model.Longitude" != "" && "@Model.Latitude" != "") {
                                    localStorage.setItem("marker-lat", @Model.Latitude);
                                    localStorage.setItem("marker-long", @Model.Longitude);
                                }

                                if (localStorage.hasOwnProperty("marker-lat") && localStorage.hasOwnProperty("marker-long")) {

                                    var latitCenter = JSON.parse(localStorage.getItem("marker-lat"));
                                    var longCenter = JSON.parse(localStorage.getItem("marker-long"));

                                    map = new google.maps.Map(document.getElementById('map'), {
                                        center: { lat: latitCenter, lng: longCenter },
                                        zoom: 11
                                    });
                                }
                                else {
                                    map = new google.maps.Map(document.getElementById('map'), {
                                        center: { lat: 53.90588468960213, lng: 27.555191727187893 },
                                        zoom: 11
                                    });
                                }
                            }
                        </script>

                    </div>
                </div>

                <label class="btn btn-outline-primary mt-3" onclick="HideErrorSpan('AddressLatitideLongitudeError'); setUpTheMarker()">Search vehicle</label>

                <div class="mt-4">
                    <div class="d-flex flex-row visually-hidden">
                        <span class="text-muted h5 mt-2 mr-2">Latitude: </span>
                        <input asp-for="Latitude" type="text" class="form-control text-center" style="width: 15%" id="latit" readonly>
                        <span class="text-muted h5 ml-4 mt-2">Longitude: </span>
                        <input asp-for="Longitude" type="text" class="form-control text-center ml-2" style="width: 15%" id="longit" readonly>
                    </div>
                </div>

            </div>

            <div class="col-md-5">
                <div class="position-sticky" style="top: 3rem;">
                    <div class="mt-4">
                        <label for="firstName" class="mt-4">Vehicle name</label>
                        <input asp-for="Name" type="text" class="form-control" id="firstName" placeholder="" onfocus="HideErrorSpan('NameError')">
                        <span asp-validation-for="Name" id="NameError" class="text-danger"></span>
                    </div>

                    <div class="mt-2">
                        <label for="firstName">Brief Description</label>
                        <textarea asp-for="BriefDescription" class="form-control" id="exampleFormControlTextarea1" rows="4" style="resize: none" onfocus="HideErrorSpan('BriefDescriptionError')" onkeydown="CheckTextAreaInput(event)"></textarea>
                        <span asp-validation-for="BriefDescription" id="BriefDescriptionError" class="text-danger"></span>
                    </div>

                    <div class="mt-2">
                        <label for="firstName">Basic Tariff</label>
                        <div class="d-flex flex-row">
                            <input asp-for="HourlyRentalPrice" type="number" class="form-control text-center" style="width: 25%" onfocus="HideErrorSpan('HoursTariffError')">
                            <span class="text-muted h5 ml-1 mt-2">$/hr - </span>
                            <input asp-for="DailyRentalPrice" type="number" class="form-control text-center ml-2" style="width: 25%" onfocus="HideErrorSpan('DailyTariffError')">
                            <span class="text-muted h5 ml-1 mt-2">$/day</span>
                        </div>
                        <span asp-validation-for="HourlyRentalPrice" id="HoursTariffError" class="text-danger"></span>
                        <span asp-validation-for="DailyRentalPrice" id="DailyTariffError" class="text-danger"></span>
                    </div>

                    <div class="mt-2">
                        <label for="firstName">Description</label>
                        <textarea asp-for="Description" class="form-control" id="exampleFormControlTextarea1" rows="9" style="resize: none" onfocus="HideErrorSpan('DescriptionError')" onkeydown="CheckTextAreaInput(event)"></textarea>
                        <span asp-validation-for="Description" id="DescriptionError" class="text-danger"></span>
                    </div>

                    <nav class="blog-pagination mt-4" aria-label="Pagination">
                        <button type="submit" class="btn btn-outline-primary w-25">Share</button>
                    </nav>
                </div>

            </div>
        </form>

        <script>
            $('#createNewVehicleForm').submit(function () {
                let sending = true;

                document.getElementById("categoriesInput").value = vehicleCategories.toString();

                if (document.getElementById('latit').value === "" || document.getElementById('longit').value === "") {
                    document.getElementById('AddressLatitideLongitudeError').textContent = "Vehicle address must be determined on the map based on the data you've entered. Fill in all the fields, click «Search vehicle» button and then try again.";
                    sending = false;
                }

                return sending;
            });
        </script>

    </div>

</main>

<script src="~/js/addVehiclePage.js" asp-append-version="true"></script>

<script>
    const vehicleCategories = [];

    function FilterCategories(checkboxElement, category){
        if (checkboxElement.checked) {
            vehicleCategories.push(category);
        } else {
            var index = vehicleCategories.indexOf(category);
            vehicleCategories.splice(index, 1);
        }
    }
</script>

<script>
    (() => {
        'use strict'

        const forms = document.querySelectorAll('.needs-validation')

        Array.from(forms).forEach(form => {
            form.addEventListener('submit', event => {                
                if (!form.checkValidity()) {
                    event.preventDefault()
                    event.stopPropagation()
                }
                
                form.classList.add('was-validated')
            }, false)
        })
    })()
</script>
